%% ================== 完整 GoogLeNet 训练代码 ==================
clear; clc; close all;

%% --- 1. 数据准备 ---
baseFolder = 'D:\4TCS1\TIP\food-11\food-11';
trainFolder = fullfile(baseFolder, 'train');
testFolder  = fullfile(baseFolder, 'test');

imds = imageDatastore(trainFolder, 'IncludeSubfolders', true, 'LabelSource', 'foldernames');

[imdsTrain, imdsValidation] = splitEachLabel(imds, 0.7, 'randomized');
fprintf('Training images: %d, Validation images: %d\n', numel(imdsTrain.Files), numel(imdsValidation.Files));

classNames = categories(imdsTrain.Labels);
numClasses = numel(classNames);
fprintf('Number of classes: %d\n', numClasses);

%% --- 2. 简单 Oversampling 平衡训练集 ---
tbl = countEachLabel(imdsTrain);
maxCount = max(tbl.Count);

augFiles = {};
augLabels = [];

for i = 1:numClasses
    lbl = tbl.Label(i);
    files = imdsTrain.Files(imdsTrain.Labels == lbl);
    n = numel(files);
    if n < maxCount
        idx = randi(n, maxCount - n, 1);
        augFiles = [augFiles; files(idx)];
        augLabels = [augLabels; repmat(lbl, maxCount - n, 1)];
    end
end

% 重新创建训练集 datastore
allFiles = [imdsTrain.Files; augFiles];
allLabels = [imdsTrain.Labels; categorical(augLabels)];
imdsTrain = imageDatastore(allFiles);
imdsTrain.Labels = allLabels;

fprintf('Balanced training set size: %d\n', numel(imdsTrain.Files));


%% --- 3. 使用 GoogLeNet ---
net = googlenet;
inputSize = net.Layers(1).InputSize(1:2);
fprintf('Using GoogLeNet\n');

%% --- 4. 数据增强 ---
augmenter = imageDataAugmenter( ...
    'RandRotation', [-10 10], ...
    'RandXReflection', true, ...
    'RandXTranslation', [-5 5], ...
    'RandYTranslation', [-5 5], ...
    'RandScale', [0.9 1.1]);

augImdsTrain = augmentedImageDatastore(inputSize, imdsTrain, 'DataAugmentation', augmenter);
augImdsVal   = augmentedImageDatastore(inputSize, imdsValidation);

%% --- 5. 替换最后层 ---
lgraph = layerGraph(net);
lgraph = removeLayers(lgraph, {'loss3-classifier','prob','output'});

newLayers = [
    fullyConnectedLayer(numClasses, 'Name','fc', 'WeightLearnRateFactor',10, 'BiasLearnRateFactor',10)
    softmaxLayer('Name','softmax')
    classificationLayer('Name','classoutput')];

lgraph = addLayers(lgraph,newLayers);
lgraph = connectLayers(lgraph,'pool5-drop_7x7_s1','fc');

%% --- 6. 训练选项 ---
miniBatchSize = 64;
options = trainingOptions('adam', ...
    'MiniBatchSize', miniBatchSize, ...
    'MaxEpochs', 15, ...           % 可以适当增加训练轮数
    'InitialLearnRate', 1e-4, ...
    'ValidationData', augImdsVal, ...
    'ValidationFrequency', floor(numel(augImdsTrain.Files)/miniBatchSize), ...
    'Shuffle','every-epoch', ...
    'Verbose',true, ...
    'Plots','training-progress', ...
    'ExecutionEnvironment','auto');

%% --- 7. 训练网络 ---
tic;
trainedNet = trainNetwork(augImdsTrain, lgraph, options);
trainTime = toc;
fprintf('Training finished in %.2f seconds.\n', trainTime);

%% --- 8. 验证集评估 ---
[YPred, ~] = classify(trainedNet, augImdsVal);
YValidation = imdsValidation.Labels;
accuracy = mean(YPred == YValidation);
fprintf('Validation Accuracy: %.2f%%\n', accuracy*100);

figure;
confusionchart(YValidation, YPred);
title('Confusion Matrix (Validation Set)');

%% --- 9. 测试集预测并保存为 JSON ---
imdsTest = imageDatastore(testFolder, 'IncludeSubfolders', false);
augImdsTest = augmentedImageDatastore(inputSize, imdsTest);

YPredTest = classify(trainedNet, augImdsTest);

jsonMap = containers.Map('KeyType', 'char', 'ValueType', 'char'); 
for i = 1:numel(imdsTest.Files)
    [~, name, ~] = fileparts(imdsTest.Files{i});
    jsonMap(name) = char(YPredTest(i));
end

jsonStr = jsonencode(jsonMap);
outputFile = fullfile(pwd, "test_predictions_googlenet.json"); 
fid = fopen(outputFile, 'w');
if fid == -1
    error('Cannot create JSON file.');
end
fprintf(fid, '%s', jsonStr);
fclose(fid);
fprintf('✅ Prediction JSON saved to: %s\n', outputFile);
